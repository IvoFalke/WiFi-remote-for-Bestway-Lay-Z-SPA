<!DOCTYPE html>
<html>
<head>
    <title>Lay-Z-Spa Module | MQTT Config</title>
	<link rel="icon" type="image/png" sizes="300x300" href="favicon.png">
	<link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="main.css" type="text/css">
    <meta name="theme-color" content="#0066BF">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
</head>

<body onload="loadconfig()">
	<div id="site">
		<header>
			<span>MQTT Config <a href="/">[back]</a></span>
		</header>

        <section>
			<table>
				<tr>
					<td><label for="enableMQTT">Enable MQTT:</label></td>
					<td><input type="checkbox" id="enableMQTT"></td>
				</tr>
				<tr>
					<td>IP:</td>
					<td>
						<input type="text" id="ip1" maxlength="3" style="width:30px">
						. <input type="text" id="ip2" maxlength="3" style="width:30px">
						. <input type="text" id="ip3" maxlength="3" style="width:30px">
						. <input type="text" id="ip4" maxlength="3" style="width:30px">
					</td>
				</tr>
				<tr>
					<td>Port:</td>
					<td><input type="text" id="port"></td>
				</tr>
				<tr>
					<td>Username:</td>
					<td><input type="text" id="name"></td>
				</tr>
				<tr>
					<td>Password:</td>
					<td><input type="text" id="pwd"></td>
				</tr>
				<tr>
					<td>Client ID:</td>
					<td><input type="text" id="clientID"></td>
				</tr>
				<tr>
					<td>Base Topic:</td>
					<td><input type="text" id="topic"></td>
				</tr>
				<tr>
					<td colspan="2" style="text-align:center"><button id="save" class="button" onclick="saveconfig()">save</button></td>
				</tr>
			</table>
        </section>
	</div>

<script>
function loadconfig(){
	const Http = new XMLHttpRequest();
	const url='/getmqtt/';
	Http.open("POST", url);
	Http.send();

	Http.onreadystatechange = function(){
		if(this.readyState==4 && this.status==200){
			console.log(Http.responseText);
			var msgobj = JSON.parse(Http.responseText);
			document.getElementById("ip1").value = msgobj.mqtt_server_ip[0];
			document.getElementById("ip2").value = msgobj.mqtt_server_ip[1];
			document.getElementById("ip3").value = msgobj.mqtt_server_ip[2];
			document.getElementById("ip4").value = msgobj.mqtt_server_ip[3];
			document.getElementById("port").value = msgobj.mqtt_port;
			document.getElementById("name").value = msgobj.mqtt_username;
			document.getElementById("pwd").value = msgobj.mqtt_password;
			document.getElementById("clientID").value = msgobj.mqtt_client_id;
			document.getElementById("topic").value = msgobj.base_mqtt_topic;
			document.getElementById("enableMQTT").checked = msgobj.enableMQTT;
		}
	}
}

function saveconfig(){
	const Http = new XMLHttpRequest();
	const url='/setmqtt/';
	Http.open("POST", url);

	var msgobj = {
		"mqtt_server_ip":[parseInt(document.getElementById("ip1").value),
						parseInt(document.getElementById("ip2").value),
						parseInt(document.getElementById("ip3").value),
						parseInt(document.getElementById("ip4").value)],
		"mqtt_port":parseInt(document.getElementById("port").value),
		"mqtt_username":(document.getElementById("name").value),
		"mqtt_password":(document.getElementById("pwd").value),
		"mqtt_client_id":(document.getElementById("clientID").value),
		"base_mqtt_topic":(document.getElementById("topic").value),
		"enableMQTT":(document.getElementById("enableMQTT").checked)
	};
	Http.send(JSON.stringify(msgobj));
	console.log(msgobj);
	alert("Saved.");
	window.location.replace("/");
}
</script>	
</body>
</html>
